id: com.obsproject.Studio.Plugin.BackgroundRemoval
branch: stable
runtime: com.obsproject.Studio
runtime-version: stable
sdk: org.kde.Sdk//6.8
build-extension: true
separate-locales: false
build-options:
  prefix: /app/plugins/BackgroundRemoval
modules:
  - name: opencv
    buildsystem: cmake-ninja
    builddir: true
    config-opts: 
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DBUILD_SHARED_LIBS=ON"
      - "-DOPENCV_GENERATE_PKGCONFIG=ON"
      - "-DBUILD_LIST=core,imgproc,imgcodecs"
      - "-DBUILD_TESTS=OFF"
      - "-DBUILD_PERF_TESTS=OFF"
      - "-DBUILD_EXAMPLES=OFF"
      - "-DBUILD_DOCS=OFF"
      - "-DBUILD_opencv_apps=OFF"
      - "-DWITH_JPEG=OFF"
      - "-DWITH_PNG=OFF"
      - "-DWITH_TIFF=OFF"
      - "-DWITH_JASPER=OFF"
      - "-DWITH_WEBP=OFF"
      - "-DWITH_OPENJPEG=OFF"
      - "-DWITH_OPENEXR=OFF"
      - "-DWITH_FFMPEG=OFF"
      - "-DWITH_GSTREAMER=OFF"
      - "-DWITH_IPP=OFF"
      - "-DWITH_LAPACK=OFF"
      - "-DWITH_PROTOBUF=OFF"
      - "-DWITH_QUIRC=OFF"
      - "-DWITH_GTK=OFF"
      - "-DWITH_QT=OFF"
      - "-DWITH_OPENGL=OFF"
      - "-DWITH_CUDA=OFF"
      - "-DWITH_EIGEN=OFF"
    sources: 
      - type: "git"
        url: "https://github.com/opencv/opencv.git"
        tag: "4.11.0"
        commit: "31b0eeea0b44b370fd0712312df4214d4ae1b158"
      - type: "patch"
        path: "patches/opencv4/0002-install-options.patch"
      - type: "patch"
        path: "patches/opencv4/0003-force-package-requirements.patch"
      - type: "patch"
        path: "patches/opencv4/0004-fix-eigen.patch"
      - type: "patch"
        path: "patches/opencv4/0005-fix-policy-CMP0057.patch"
      - type: "patch"
        path: "patches/opencv4/0006-fix-uwp.patch"
      - type: "patch"
        path: "patches/opencv4/0008-devendor-quirc.patch"
      - type: "patch"
        path: "patches/opencv4/0009-fix-protobuf.patch"
      - type: "patch"
        path: "patches/opencv4/0010-fix-uwp-tiff-imgcodecs.patch"
      - type: "patch"
        path: "patches/opencv4/0011-remove-python2.patch"
      - type: "patch"
        path: "patches/opencv4/0012-miss-openexr.patch"
      - type: "patch"
        path: "patches/opencv4/0014-fix-cmake-in-list.patch"
      - type: "patch"
        path: "patches/opencv4/0015-fix-freetype.patch"
      - type: "patch"
        path: "patches/opencv4/0017-fix-flatbuffers.patch"
      - type: "patch"
        path: "patches/opencv4/0019-opencl-kernel.patch"
      - type: "patch"
        path: "patches/opencv4/0020-fix-narrow-filesystem.diff"
      - type: "patch"
        path: "patches/opencv4/0021-fix-qt-gen-def.patch"
  - name: onnxruntime
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/include/onnxruntime
      - cp -r include/* ${FLATPAK_DEST}/include/onnxruntime/
      - sed -i lib/cmake/onnxruntime/onnxruntimeTargets-release.cmake -e 's/lib64/lib/g'
      - cp -r lib/* ${FLATPAK_DEST}/lib/
      - mkdir -p ${FLATPAK_DEST}/share/onnxruntime
      - install -Dm644 LICENSE Privacy.md README.md ThirdPartyNotices.txt ${FLATPAK_DEST}/share/onnxruntime/
    sources:
      - type: archive
        url: https://github.com/microsoft/onnxruntime/releases/download/v1.23.2/onnxruntime-linux-x64-1.23.2.tgz
        sha256: 1fa4dcaef22f6f7d5cd81b28c2800414350c10116f5fdd46a2160082551c5f9b
  - name: obs-backgroundremoval
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_PREFIX_PATH=/app/plugins/BackgroundRemoval
      - -DENABLE_FRONTEND_API=ON
      - -DENABLE_QT=ON
      - -DUSE_PKGCONFIG=ON
    sources:
      - type: git
        url: https://github.com/royshil/obs-backgroundremoval.git
        branch: umireon/use-system-onnxruntime
        x-checker-data:
          type: git
          tag-pattern: ^([\\d.]+)$
      - type: file
        path: com.obsproject.Studio.Plugin.BackgroundRemoval.metainfo.xml
    post-install:
      - install -Dm644 --target-directory=${FLATPAK_DEST}/share/metainfo ${FLATPAK_BUILDER_BUILDDIR}/${FLATPAK_ID}.metainfo.xml
cleanup:
  - /bin
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /lib64/cmake
  - /lib64/pkgconfig